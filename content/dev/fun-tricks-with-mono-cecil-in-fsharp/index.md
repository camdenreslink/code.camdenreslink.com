+++
title = "Fun Tricks with Mono Cecil in F#"
subtitle = "Using Mono Cecil to Discover Things About Your .NET Projects"
bannerFigCaption = ""
date = "2018-02-24"
summary = "Static code analysis is investigating the structure of a program without actually executing it (as opposed to things that happen at runtime like logging, running unit tests, or debugging). In this post, we'll be investigating interesting ways to leverage the Mono.Cecil library to analyze .NET projects."
draft=true
+++

*Disclaimer: Some of the things described in this post can probably be accomplished with the [.NET Compiler Platform (i.e. Roslyn)](https://github.com/dotnet/roslyn). I haven't had a chance to play around with that yet, so I use Mono.Cecil for some similar tasks.*

Background
==========

Static code analysis is investigating the structure of a program without actually executing it (as opposed to things that happen at runtime like logging, running unit tests, or debugging). This can be done via examining an [Abstract Syntax Tree (AST)](https://github.com/dotnet/roslyn/wiki/Getting-Started-C%23-Syntax-Analysis) generated by parsing the C#/VB/F#. It can also be accomplished by analyzing the [Common Intermediate Language (CIL)](https://en.wikipedia.org/wiki/Common_Intermediate_Language) bytecode generated by compiling your .NET applications. We will be using the latter strategy.

*Note: CIL bytecode is sometimes also called IL, MSIL (Microsoft Intermediate Language), or just "bytecode".*

CIL bytecode is what is generated when you compile a .NET application. This bytecode then gets run using a CIL compatible runtime (.NET Framework, .NET Core, Mono).

TODO: Graph depicting Source File -> CIL Bytecode -> Runtime executing code on processor

If you've never seen CIL Bytecode before, try installing an extension for Visual Studio called [ILSpy](https://github.com/icsharpcode/ILSpy) (coincidentally, this tool was written using Mono.Cecil). This tool will allow you to right click on a method or class in Visual Studio and select "Open code in ILSpy". A window will appear with the IL instructions that correspond to that method or class.

{{< figure-resource resource="img/screenshot_ILSpy.png" >}}

Mono.Cecil
==========

[Mono.Cecil](https://github.com/jbevain/cecil) is a library that analyzes a file containing IL instructions (a `.dll` or `.exe` assembly file), and creates a data structure that you can then traverse. Despite its name, it can be used for IL code compiled to run against the .NET Framework, not just Mono. It also allows for the rewriting of IL instructions, so you can modify the assembly to customize its behavior even after it has been compiled. This is sometimes referred to as IL Weaving, and is how [Aspect Oriented Programming (AOP)](https://www.postsharp.net/aop.net) is accomplished. Cecil is a very popular library, and is used in all sorts of open source and commercial projects. See the list [here](https://github.com/jbevain/cecil/wiki/Users).

Sample Project to Analyze
=========================

If we're going to be writing code that analyzes .NET code, we're going to need some an example project to analyze. Instead of writing this example code, I decided to use an open source project called [SmartStoreNET](http://www.smartstore.com/en/net). It is an e-commerce shopping cart solution implemented using ASP.NET MVC.

So, to get set up to do some analyzing we need to do the following steps:

1. Clone the SmartStoreNET repository: [Link to the repository](https://github.com/smartstoreag/SmartStoreNET)
2. Navigate to `SmartStoreNET\src\` and open `SmartStoreNET.sln` in Visual Studio.
3. Restore the NuGet packages, and build the solution.
4. We now have an entire directory of assemblies that we can play around with located at `SmartStoreNET\src\Presentation\SmartStore.Web\bin`.

Setting Up Our Analyzer Project
===============================

We will be using F# to do our analysis. I like to use F# for tasks like this, because it can be used as a scripting language. Quick ad-hoc queries can be done without a lot of setup. It has nice integration with the .NET platform, so you can interop with libraries that were originally intended to be used with C#.

Open Visual Studio, and select `File > New > Project`. Within the New Project window, navigate to the "Visual F#" section and select "Console Application". Choose a name and location for your project. I chose to name mine "Mono.Cecil_FunTricks". The paths in the rest of this post will assume this project name.

{{< figure-resource resource="img/screenshot_NewProject.png" >}}

*Note: If you don't already have F# language tools installed for Visual Studio, you'll have to do that. Go to `Tools > Get Tools and Features`. This will open the Visual Studio Installer window. Under the Individual Components tab, navigate to the Development Activities header and make sure "F# language support" is checked. Then click the "Modify" button on the bottom right of the window. All Visual Studio windows need to be closed for the installer to work.*

I will be using [Paket](https://fsprojects.github.io/Paket/) to manage my dependencies. To read more about the benefits of Paket, check out the [FAQ](https://fsprojects.github.io/Paket/faq.html). To set up Paket:

1. Navigate in the file explorer to the root directory of our solution: `Mono.Cecil_FunTricks\`.
2. Create a directory named `.paket`. You may get an error saying "You must type a file name." You get this error whenever you try creating a directory that starts with a period character. To circumvent this, create a directory named `.paket.`. Then Windows will automatically truncate the last period character leaving us with our desired directory name. (I got that tip [here](https://superuser.com/a/483763) after having some trouble with it).
3. Download the latest [paket.bootstrapper.exe](https://github.com/fsprojects/Paket/releases/latest) into the `.paket` directory.
4. Run `.paket/paket.bootstrapper.exe`. It will download the latest `paket.exe`.
5. Create a file named `paket.dependencies` in the root directory of our solution: `SmartStoreNET\`. Add the following lines to this file:`source https://nuget.org/api/v2`, `nuget Mono.Cecil`
6. Navigate to the directory containing your F# project (`.fsproj`), and create a file named `paket.references` in it. Add the following line to this file: `Mono.Cecil`.

So, we should have the following:

{{< highlight-custom language="text" header-text="Mono.Cecil_FunTricks\paket.dependencies" >}}
source https://nuget.org/api/v2

nuget Mono.Cecil
{{< /highlight-custom >}}

{{< highlight-custom language="text" header-text="Mono.Cecil_FunTricks\Mono.Cecil_FunTricks\paket.references" >}}
Mono.Cecil
{{< /highlight-custom >}}

Try running the following command to install your packages:
{{< highlight-custom language="text" header-text="command line" >}}
.paket/paket.exe install
{{< /highlight-custom >}}

We should now be ready to start modifying and building our F# source code!

A Quick Mono.Cecil Test
=======================

We will do a quick test, just to make sure that we can use Cecil, and our project is set up correctly. Add the following line to the top of your `Program.fs` file: `open Mono.Cecil`. This is very similar to a using statement in C#.